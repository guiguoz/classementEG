<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√âpreuve T2 - TEST</title>
    <link rel="stylesheet" href="shared/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="team-name" id="team-name">Chargement...</div>
                <div class="status" id="total-score">Score: --</div>
            </div>
            <div class="score">√âpreuve T2</div>
        </div>

        <div class="card">
            <div class="emoji">üß™</div>
            <h1>Test √âpreuve 2</h1>
            <h2>Test d'enregistrement de score</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Cliquez sur les boutons pour tester le syst√®me de score.</p>

            <div id="feedback" class="feedback"></div>

            <button class="btn btn-score" id="btn-correct" onclick="submitAnswer('test2')">
                ‚úÖ Bonne r√©ponse (+1000 pts)
            </button>

            <button class="btn btn-wrong" id="btn-wrong" onclick="submitAnswer('mauvais')">
                ‚ùå Mauvaise r√©ponse (-100 pts)
            </button>

            <button class="btn btn-hint" id="btn-hint" onclick="getHint()">
                üí° Demander indice (-100 pts)
            </button>

            <div class="status" id="attempts-display">Tentative: 1 | Points possibles: 1000</div>
        </div>

    </div>

    <script>
        const API_BASE_URL = 'https://hebergementvikazimut.vikazim.fr/escapegame/api';
        const GAME_ID = 'archi';
        const STORAGE_KEY_UUID = `vikazimut_team_uuid_${GAME_ID}`;
        const CHALLENGE_ID = 'T2';

        let attempts = 1;
        let hintUsed = false;

        function getTeamUUID() { return localStorage.getItem(STORAGE_KEY_UUID); }

        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data && method !== 'GET') options.body = JSON.stringify(data);
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`R√©ponse non-JSON (${response.status}): ${text.slice(0, 120)}`);
            }
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Erreur API');
            return result.data;
        }

        function showFeedback(msg, type) {
            const el = document.getElementById('feedback');
            el.textContent = msg;
            el.className = `feedback ${type} show`;
        }

        function updateDisplay() {
            const pts = Math.max(0, 1000 - (attempts - 1) * 100 - (hintUsed ? 100 : 0));
            document.getElementById('attempts-display').textContent = `Tentative: ${attempts} | Points possibles: ${pts}`;
        }

        async function submitAnswer(answer) {
            const uuid = getTeamUUID();
            if (!uuid) return showFeedback('Pas d\'√©quipe ! Retournez √† l\'accueil.', 'error');

            try {
                const result = await apiCall('/score.php?action=validate', 'POST', {
                    uuid, challenge_id: CHALLENGE_ID, answer, attempts, hint_used: hintUsed
                });

                if (result.correct) {
                    showFeedback(`‚úÖ Score enregistr√© : +${result.points} points !`, 'success');
                    document.getElementById('btn-correct').disabled = true;
                    document.getElementById('btn-wrong').disabled = true;
                    document.getElementById('btn-hint').disabled = true;
                    if (typeof Vikazimut !== 'undefined') Vikazimut.postMessage("1");
                } else {
                    attempts++;
                    updateDisplay();
                    showFeedback(`‚ùå Mauvaise r√©ponse. Tentative ${attempts}.`, 'error');
                }
            } catch (err) {
                showFeedback(err.message, 'error');
            }
        }

        async function getHint() {
            if (hintUsed) return showFeedback('Indice d√©j√† utilis√©', 'hint');
            try {
                const result = await apiCall(`/score.php?action=hint&challenge_id=${CHALLENGE_ID}&game_id=${GAME_ID}`);
                hintUsed = true;
                updateDisplay();
                showFeedback(`üí° ${result.hint}`, 'hint');
                document.getElementById('btn-hint').disabled = true;
            } catch (err) {
                showFeedback(err.message, 'error');
            }
        }

        async function loadTeam() {
            const uuid = getTeamUUID();
            if (!uuid) {
                document.getElementById('team-name').textContent = '‚ö†Ô∏è Pas d\'√©quipe';
                return;
            }
            try {
                const session = await apiCall(`/team.php?action=session&uuid=${uuid}`);
                document.getElementById('team-name').textContent = session.name;
                document.getElementById('total-score').textContent = `Score: ${session.total_score} pts`;
                if (session.challenges_completed.includes(CHALLENGE_ID)) {
                    showFeedback('‚úÖ √âpreuve d√©j√† valid√©e', 'success');
                    document.getElementById('btn-correct').disabled = true;
                    document.getElementById('btn-wrong').disabled = true;
                    document.getElementById('btn-hint').disabled = true;
                }
            } catch (err) {
                document.getElementById('team-name').textContent = '‚ö†Ô∏è Erreur';
            }
        }

        document.addEventListener('DOMContentLoaded', loadTeam);
    </script>
</body>
</html>
