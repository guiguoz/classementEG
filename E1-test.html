<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√âpreuve T1 - TEST</title>
    <style>
        :root { --bg-dark:#0f0f23; --bg-card:#16213e; --bg-card2:#1a1a2e; --border:#2a2a4a; --accent:#e94560; --accent2:#ff6b8a; --green:#4ecca3; --gold:#f0a500; --cyan:#00e5ff; --text:#e0e0e0; --text-muted:#a0a0b8; --radius:16px; }
        * { box-sizing:border-box; margin:0; padding:0; }
        body { font-family:'Segoe UI',sans-serif; background:linear-gradient(135deg,var(--bg-dark),var(--bg-card),#0f3460); color:var(--text); min-height:100vh; padding:20px; }
        .container { max-width:600px; margin:0 auto; }
        .header { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; }
        .team-name { color:var(--cyan); font-weight:600; }
        .score { color:var(--gold); font-weight:700; }
        .card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:30px; margin-bottom:20px; text-align:center; }
        h1 { color:var(--accent); font-size:28px; margin-bottom:10px; }
        h2 { color:var(--gold); font-size:20px; margin-bottom:20px; }
        .emoji { font-size:60px; margin-bottom:20px; }
        .btn { width:100%; padding:18px; border-radius:12px; font-size:18px; font-weight:600; cursor:pointer; border:none; margin:8px 0; transition:all .2s; }
        .btn:disabled { opacity:.5; cursor:not-allowed; }
        .btn-score { background:linear-gradient(135deg,var(--green),#2ecc71); color:white; }
        .btn-score:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 5px 20px rgba(78,204,163,.4); }
        .btn-wrong { background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white; }
        .btn-wrong:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 5px 20px rgba(233,69,96,.4); }
        .btn-hint { background:var(--gold); color:var(--bg-dark); }
        .btn-nav { background:var(--bg-card2); color:var(--text); border:1px solid var(--border); }
        .btn-nav:hover { border-color:var(--accent); }
        .feedback { padding:15px; border-radius:12px; margin:15px 0; font-weight:600; text-align:center; display:none; }
        .feedback.show { display:block; }
        .feedback.success { background:rgba(78,204,163,.2); border:2px solid var(--green); color:var(--green); }
        .feedback.error { background:rgba(233,69,96,.2); border:2px solid var(--accent); color:var(--accent); }
        .feedback.hint { background:rgba(240,165,0,.2); border:2px solid var(--gold); color:var(--gold); }
        .nav { display:flex; gap:10px; margin-top:10px; }
        .nav .btn-nav { flex:1; padding:14px; }
        .status { color:var(--text-muted); font-size:14px; margin-top:10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="team-name" id="team-name">Chargement...</div>
                <div class="status" id="total-score">Score: --</div>
            </div>
            <div class="score">√âpreuve T1</div>
        </div>

        <div class="card">
            <div class="emoji">üß™</div>
            <h1>Test √âpreuve 1</h1>
            <h2>Test d'enregistrement de score</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Cliquez sur les boutons pour tester le syst√®me de score.</p>

            <div id="feedback" class="feedback"></div>

            <button class="btn btn-score" id="btn-correct" onclick="submitAnswer('test1')">
                ‚úÖ Bonne r√©ponse (+1000 pts)
            </button>

            <button class="btn btn-wrong" id="btn-wrong" onclick="submitAnswer('mauvais')">
                ‚ùå Mauvaise r√©ponse (-100 pts)
            </button>

            <button class="btn btn-hint" id="btn-hint" onclick="getHint()">
                üí° Demander indice (-100 pts)
            </button>

            <div class="status" id="attempts-display">Tentative: 1 | Points possibles: 1000</div>
        </div>

    </div>

    <script>
        const API_BASE_URL = 'https://hebergementvikazimut.vikazim.fr/escapegame/api';
        const GAME_ID = 'archi';
        const STORAGE_KEY_UUID = `vikazimut_team_uuid_${GAME_ID}`;
        const CHALLENGE_ID = 'T1';

        let attempts = 1;
        let hintUsed = false;

        function getTeamUUID() { return localStorage.getItem(STORAGE_KEY_UUID); }

        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data && method !== 'GET') options.body = JSON.stringify(data);
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`R√©ponse non-JSON (${response.status}): ${text.slice(0, 120)}`);
            }
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Erreur API');
            return result.data;
        }

        function showFeedback(msg, type) {
            const el = document.getElementById('feedback');
            el.textContent = msg;
            el.className = `feedback ${type} show`;
        }

        function updateDisplay() {
            const pts = Math.max(0, 1000 - (attempts - 1) * 100 - (hintUsed ? 100 : 0));
            document.getElementById('attempts-display').textContent = `Tentative: ${attempts} | Points possibles: ${pts}`;
        }

        async function submitAnswer(answer) {
            const uuid = getTeamUUID();
            if (!uuid) return showFeedback('Pas d\'√©quipe ! Retournez √† l\'accueil.', 'error');

            try {
                const result = await apiCall('/score.php?action=validate', 'POST', {
                    uuid, challenge_id: CHALLENGE_ID, answer, attempts, hint_used: hintUsed
                });

                if (result.correct) {
                    showFeedback(`‚úÖ Score enregistr√© : +${result.points} points !`, 'success');
                    document.getElementById('btn-correct').disabled = true;
                    document.getElementById('btn-wrong').disabled = true;
                    document.getElementById('btn-hint').disabled = true;
                    if (typeof Vikazimut !== 'undefined') Vikazimut.postMessage("1");
                } else {
                    attempts++;
                    updateDisplay();
                    showFeedback(`‚ùå Mauvaise r√©ponse. Tentative ${attempts}.`, 'error');
                }
            } catch (err) {
                showFeedback(err.message, 'error');
            }
        }

        async function getHint() {
            if (hintUsed) return showFeedback('Indice d√©j√† utilis√©', 'hint');
            try {
                const result = await apiCall(`/score.php?action=hint&challenge_id=${CHALLENGE_ID}&game_id=${GAME_ID}`);
                hintUsed = true;
                updateDisplay();
                showFeedback(`üí° ${result.hint}`, 'hint');
                document.getElementById('btn-hint').disabled = true;
            } catch (err) {
                showFeedback(err.message, 'error');
            }
        }

        async function loadTeam() {
            const uuid = getTeamUUID();
            if (!uuid) {
                document.getElementById('team-name').textContent = '‚ö†Ô∏è Pas d\'√©quipe';
                return;
            }
            try {
                const session = await apiCall(`/team.php?action=session&uuid=${uuid}`);
                document.getElementById('team-name').textContent = session.name;
                document.getElementById('total-score').textContent = `Score: ${session.total_score} pts`;
                if (session.challenges_completed.includes(CHALLENGE_ID)) {
                    showFeedback('‚úÖ √âpreuve d√©j√† valid√©e', 'success');
                    document.getElementById('btn-correct').disabled = true;
                    document.getElementById('btn-wrong').disabled = true;
                    document.getElementById('btn-hint').disabled = true;
                }
            } catch (err) {
                document.getElementById('team-name').textContent = '‚ö†Ô∏è Erreur';
            }
        }

        document.addEventListener('DOMContentLoaded', loadTeam);
    </script>
</body>
</html>
